<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Evidence přání videií</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .dashboard-header {
            margin-bottom: 30px;
        }

        .dashboard-header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dashboard-header .subtitle {
            color: #7f8c8d;
            font-size: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-card.success {
            border-left-color: #27ae60;
        }

        .stat-card.warning {
            border-left-color: #f39c12;
        }

        .stat-card.danger {
            border-left-color: #e74c3c;
        }

        .stat-card .icon {
            font-size: 24px;
            margin-bottom: 10px;
            color: #3498db;
        }

        .stat-card.success .icon {
            color: #27ae60;
        }

        .stat-card.warning .icon {
            color: #f39c12;
        }

        .stat-card.danger .icon {
            color: #e74c3c;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-card .label {
            color: #7f8c8d;
            font-size: 14px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chart-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .chart-container.small {
            height: 200px;
        }

        .table-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .table-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .activity-table {
            width: 100%;
            border-collapse: collapse;
        }

        .activity-table th,
        .activity-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        .activity-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        .activity-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .refresh-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }

        .refresh-button:hover {
            background: #2980b9;
        }

        .refresh-button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .last-updated {
            text-align: right;
            color: #7f8c8d;
            font-size: 12px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <h1>
                <i class="fas fa-chart-bar"></i>
                Dashboard
            </h1>
            <p class="subtitle">Přehled systémových statistik a analytiky</p>
            <button id="refresh-btn" class="refresh-button">
                <i class="fas fa-sync-alt"></i>
                Obnovit data
            </button>
        </div>

        <!-- Loading State -->
        <div id="loading" class="loading">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p>Načítám dashboard...</p>
        </div>

        <!-- Error State -->
        <div id="error" class="error" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="error-message"></span>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard-content" style="display: none;">
            <!-- Summary Statistics -->
            <div id="stats-grid" class="stats-grid">
                <!-- Stats cards will be populated by JavaScript -->
            </div>

            <!-- Charts Grid -->
            <div class="charts-grid">
                <!-- Records Status Distribution -->
                <div class="chart-card">
                    <h3>
                        <i class="fas fa-chart-pie"></i>
                        Distribuce stavů záznamů
                    </h3>
                    <div class="chart-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>

                <!-- Activity Trends -->
                <div class="chart-card">
                    <h3>
                        <i class="fas fa-chart-line"></i>
                        Trendy aktivity (30 dní)
                    </h3>
                    <div class="chart-container">
                        <canvas id="trendsChart"></canvas>
                    </div>
                </div>

                <!-- Financial Overview -->
                <div class="chart-card">
                    <h3>
                        <i class="fas fa-chart-bar"></i>
                        Finanční přehled podle stavů
                    </h3>
                    <div class="chart-container">
                        <canvas id="financialChart"></canvas>
                    </div>
                </div>

                <!-- User Activity -->
                <div class="chart-card">
                    <h3>
                        <i class="fas fa-users"></i>
                        Aktivita uživatelů
                    </h3>
                    <div class="chart-container small">
                        <canvas id="userActivityChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Activity Table -->
            <div class="table-card">
                <h3>
                    <i class="fas fa-history"></i>
                    Nejaktivnější uživatelé (30 dní)
                </h3>
                <table class="activity-table">
                    <thead>
                        <tr>
                            <th>Uživatel</th>
                            <th>Počet záznamů</th>
                            <th>Aktivita</th>
                        </tr>
                    </thead>
                    <tbody id="top-users-table">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Audit Log Stats (Admin only) -->
            <div id="audit-stats" class="charts-grid" style="display: none;">
                <div class="chart-card">
                    <h3>
                        <i class="fas fa-shield-alt"></i>
                        Audit Log - Typy akcí
                    </h3>
                    <div class="chart-container small">
                        <canvas id="auditActionsChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>
                        <i class="fas fa-exclamation-triangle"></i>
                        Audit Log - Závažnost
                    </h3>
                    <div class="chart-container small">
                        <canvas id="auditSeverityChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="last-updated">
                Poslední aktualizace: <span id="last-updated"></span>
            </div>
        </div>
    </div>

    <script>
        class Dashboard {
            constructor() {
                this.charts = {};
                this.data = null;
                this.init();
            }

            async init() {
                await this.loadData();
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.getElementById('refresh-btn').addEventListener('click', () => {
                    this.loadData();
                });
            }

            async loadData() {
                try {
                    this.showLoading();
                    
                    const response = await fetch('api.php?action=dashboard-stats');
                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.message || 'Chyba při načítání dat');
                    }
                    
                    this.data = result.data;
                    this.renderDashboard();
                    this.hideLoading();
                    
                } catch (error) {
                    console.error('Chyba při načítání dashboard dat:', error);
                    this.showError(error.message);
                }
            }

            showLoading() {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('dashboard-content').style.display = 'none';
                document.getElementById('error').style.display = 'none';
                document.getElementById('refresh-btn').disabled = true;
            }

            hideLoading() {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
                document.getElementById('refresh-btn').disabled = false;
                document.getElementById('last-updated').textContent = new Date().toLocaleString('cs-CZ');
            }

            showError(message) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error-message').textContent = message;
                document.getElementById('refresh-btn').disabled = false;
            }

            renderDashboard() {
                this.renderStatsCards();
                this.renderCharts();
                this.renderTables();
            }

            renderStatsCards() {
                const container = document.getElementById('stats-grid');
                const records = this.data.records;
                const users = this.data.users;
                const financial = this.data.financial;
                const audit = this.data.audit;

                const cards = [
                    {
                        icon: 'fas fa-file-alt',
                        value: records.total_records || 0,
                        label: 'Celkem záznamů',
                        type: 'primary'
                    },
                    {
                        icon: 'fas fa-clock',
                        value: records.recent_records || 0,
                        label: 'Nové záznamy (7 dní)',
                        type: 'success'
                    },
                    {
                        icon: 'fas fa-users',
                        value: users.total_users || 0,
                        label: 'Celkem uživatelů',
                        type: 'primary'
                    },
                    {
                        icon: 'fas fa-coins',
                        value: this.formatCurrency(financial.totals.total_amount || 0),
                        label: 'Celková částka',
                        type: 'warning'
                    },
                    {
                        icon: 'fas fa-chart-line',
                        value: financial.totals.records_with_amount || 0,
                        label: 'Záznamy s částkou',
                        type: 'success'
                    }
                ];

                if (audit) {
                    cards.push({
                        icon: 'fas fa-shield-alt',
                        value: audit.recent_actions || 0,
                        label: 'Akce za 24h',
                        type: 'primary'
                    });
                }

                container.innerHTML = cards.map(card => `
                    <div class="stat-card ${card.type}">
                        <div class="icon">
                            <i class="${card.icon}"></i>
                        </div>
                        <div class="value">${card.value}</div>
                        <div class="label">${card.label}</div>
                    </div>
                `).join('');
            }

            renderCharts() {
                // Destroy existing charts
                Object.values(this.charts).forEach(chart => {
                    if (chart) chart.destroy();
                });
                this.charts = {};

                // Status Distribution Chart
                this.renderStatusChart();
                
                // Trends Chart
                this.renderTrendsChart();
                
                // Financial Chart
                this.renderFinancialChart();
                
                // User Activity Chart
                this.renderUserActivityChart();
                
                // Audit Charts (if available)
                if (this.data.audit) {
                    document.getElementById('audit-stats').style.display = 'grid';
                    this.renderAuditCharts();
                }
            }

            renderStatusChart() {
                const ctx = document.getElementById('statusChart').getContext('2d');
                const statusData = this.data.status_distribution || [];
                
                this.charts.status = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: statusData.map(item => this.getStatusLabel(item.status)),
                        datasets: [{
                            data: statusData.map(item => item.count),
                            backgroundColor: [
                                '#27ae60', // zaplaceno
                                '#3498db', // zaslano
                                '#e74c3c', // odmitnuto
                                '#f39c12'  // rozpracovane
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            renderTrendsChart() {
                const ctx = document.getElementById('trendsChart').getContext('2d');
                const trendsData = this.data.trends || [];
                
                // Group data by date
                const groupedData = {};
                trendsData.forEach(item => {
                    if (!groupedData[item.date]) {
                        groupedData[item.date] = {};
                    }
                    groupedData[item.date][item.stav] = item.count;
                });

                const dates = Object.keys(groupedData).sort().slice(-14); // Last 14 days
                
                this.charts.trends = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates.map(date => new Date(date).toLocaleDateString('cs-CZ')),
                        datasets: [{
                            label: 'Celkem záznamů',
                            data: dates.map(date => {
                                const dayData = groupedData[date];
                                return Object.values(dayData).reduce((sum, count) => sum + count, 0);
                            }),
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            renderFinancialChart() {
                const ctx = document.getElementById('financialChart').getContext('2d');
                const financialData = this.data.financial.by_status || [];
                
                this.charts.financial = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: financialData.map(item => this.getStatusLabel(item.stav)),
                        datasets: [{
                            label: 'Částka (Kč)',
                            data: financialData.map(item => item.total_amount),
                            backgroundColor: [
                                'rgba(39, 174, 96, 0.8)',
                                'rgba(52, 152, 219, 0.8)',
                                'rgba(231, 76, 60, 0.8)',
                                'rgba(243, 156, 18, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: value => this.formatCurrency(value)
                                }
                            }
                        }
                    }
                });
            }

            renderUserActivityChart() {
                const ctx = document.getElementById('userActivityChart').getContext('2d');
                const topUsers = this.data.records.top_users || [];
                
                this.charts.userActivity = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: topUsers.map(user => user.username || 'Neznámý'),
                        datasets: [{
                            label: 'Počet záznamů',
                            data: topUsers.map(user => user.count),
                            backgroundColor: 'rgba(52, 152, 219, 0.8)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y', // This makes it horizontal
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            renderAuditCharts() {
                // Audit Actions Chart
                const actionsCtx = document.getElementById('auditActionsChart').getContext('2d');
                const topActions = this.data.audit.top_actions || [];
                
                this.charts.auditActions = new Chart(actionsCtx, {
                    type: 'doughnut',
                    data: {
                        labels: topActions.map(item => this.getActionLabel(item.action_type)),
                        datasets: [{
                            data: topActions.map(item => item.count),
                            backgroundColor: [
                                '#3498db',
                                '#27ae60',
                                '#f39c12',
                                '#e74c3c',
                                '#9b59b6'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });

                // Audit Severity Chart
                const severityCtx = document.getElementById('auditSeverityChart').getContext('2d');
                const severityData = this.data.audit.by_severity || [];
                
                this.charts.auditSeverity = new Chart(severityCtx, {
                    type: 'bar',
                    data: {
                        labels: severityData.map(item => this.getSeverityLabel(item.severity)),
                        datasets: [{
                            data: severityData.map(item => item.count),
                            backgroundColor: severityData.map(item => this.getSeverityColor(item.severity))
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            renderTables() {
                // Top Users Table
                const topUsersTable = document.getElementById('top-users-table');
                const topUsers = this.data.records.top_users || [];
                
                topUsersTable.innerHTML = topUsers.map((user, index) => `
                    <tr>
                        <td>
                            <i class="fas fa-user"></i>
                            ${user.username || 'Neznámý'}
                        </td>
                        <td>${user.count}</td>
                        <td>
                            <div style="width: 100%; background: #ecf0f1; border-radius: 10px; height: 8px;">
                                <div style="width: ${(user.count / (topUsers[0]?.count || 1)) * 100}%; background: #3498db; border-radius: 10px; height: 8px;"></div>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            // Helper methods
            getStatusLabel(status) {
                const labels = {
                    'zaplaceno': 'Zaplaceno',
                    'zaslano': 'Zasláno',
                    'odmitnuto': 'Odmítnuto',
                    'rozpracovane': 'Rozpracované'
                };
                return labels[status] || status;
            }

            getActionLabel(action) {
                const labels = {
                    'login': 'Přihlášení',
                    'logout': 'Odhlášení',
                    'create_record': 'Vytvoření záznamu',
                    'update_record': 'Úprava záznamu',
                    'delete_record': 'Smazání záznamu',
                    'create_user': 'Vytvoření uživatele',
                    'update_user': 'Úprava uživatele',
                    'delete_user': 'Smazání uživatele'
                };
                return labels[action] || action;
            }

            getSeverityLabel(severity) {
                const labels = {
                    'info': 'Info',
                    'warning': 'Varování',
                    'error': 'Chyba',
                    'critical': 'Kritické'
                };
                return labels[severity] || severity;
            }

            getSeverityColor(severity) {
                const colors = {
                    'info': '#3498db',
                    'warning': '#f39c12',
                    'error': '#e74c3c',
                    'critical': '#8e44ad'
                };
                return colors[severity] || '#95a5a6';
            }

            formatCurrency(amount) {
                return new Intl.NumberFormat('cs-CZ', {
                    style: 'currency',
                    currency: 'CZK'
                }).format(amount);
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new Dashboard();
        });
    </script>
</body>
</html>